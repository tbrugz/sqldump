<project name="sqldump">
	
	<property name="src.dir" value="src"/>
	<property name="src.graphml.dir" value="src_graphml"/>
	<property name="bin.dir"  value="bin"/>
	<property name="dist.dir" value="dist"/>
	<property name="javadoc.dir" value="dist/javadoc"/>
	
	<property name="sqldump.mainclass" value="tbrugz.sqldump.SQLDump"/>
	<property name="sqldump.sqlrun.mainclass" value="tbrugz.sqldump.sqlrun.SQLRun"/>
	<property name="sqldump.sqldiff.mainclass" value="tbrugz.sqldiff.SQLDiff"/>
	
	<property file="build.properties"/>

	<path id="classpath.compile">
		<pathelement location="lib/commons-logging-1.1.1.jar"/>
		<pathelement location="lib/log4j-1.2.15.jar"/>
		<pathelement location="lib/kmlutils.jar"/>
	</path>
	
	<path id="classpath.run">
		<path refid="classpath.compile"/>
		<pathelement location="${bin.dir}"/>
		<pathelement location="${run.xtralib}"/>
	</path>

	<path id="classpath.run.jaxb">
		<path refid="classpath.run"/>
		<pathelement location="${jaxb.lib}"/>
	</path>

	<path id="classpath.run.derby">
		<path refid="classpath.run"/>
		<pathelement location="${derby.lib}"/>
	</path>
	
	<target name="prepare">
		<mkdir dir="${bin.dir}"/>
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${javadoc.dir}"/>
		<!--if>
			<available file="sqldump.properties"/>
			<then></then>
			<else>
				<copy file="sqldump.properties.template" tofile="sqldump.properties" verbose="on"/>
			</else>
		</if-->
	</target>

	<target name="compile" depends="prepare">
		<javac destdir="${bin.dir}" classpathref="classpath.compile" debug="on">
			<src path="${src.dir}"/>
			<src path="${src.graphml.dir}"/>
		</javac>
		<copy todir="${bin.dir}" >
			<fileset dir="${src.dir}">
				<include name="**/*.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="run">
		<java classpathref="classpath.run" classname="${sqldump.mainclass}">
			<arg value="${run.arg}"/>
		</java>
	</target>
	
	<!-- full test: 
		1- dump jaxb model
		2- load into different databases (sqlrun)
		3- dump from all databases
		4- compare with original (sqldiff) --> 
	<target name="test-roundtrip1">
		<!-- 1 -->
		<java classpathref="classpath.run.jaxb" classname="${sqldump.mainclass}">
			<arg value="-propfile=test/r1-sqldump-jaxb-test.properties"/>
		</java>
		<!-- 2 -->
		<java classpathref="classpath.run.derby" classname="${sqldump.sqlrun.mainclass}" fork="true">
			<arg value="-propfile=test/r2-sqlrun-derby-test.properties"/>
		</java>
		<!-- 3 -->
		<java classpathref="classpath.run.derby" classname="${sqldump.mainclass}" fork="true">
			<arg value="-propfile=test/r3-sqldump-derby-test.properties"/>
		</java>
		<!-- 4 -->
		<java classpathref="classpath.run.jaxb" classname="${sqldump.sqldiff.mainclass}">
			<arg value="-propfile=test/r4-sqldiff-test.properties"/>
		</java>
	</target>
	
	<target name="jar" depends="prepare">
		<jar destfile="${dist.dir}/sqldump.jar"
			basedir="${bin.dir}"
			includes="**/*.class, *.properties, **/jaxb.index">
			<manifest>
				<attribute name="Main-Class" value="${sqldump.mainclass}"/>
			</manifest>
		</jar>
	</target>

	<target name="javadoc" depends="prepare">
		<javadoc destdir="${javadoc.dir}" sourcepath="${src.dir}" />
	</target>
	
	<target name="all" depends="javadoc, jar">
		<!--copy todir="${dist.dir}/" verbose="on" file="sqldump.properties"/-->
	</target>
	
</project>